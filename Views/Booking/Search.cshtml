@*@model AmiFlota.Models.ViewModels.BookingVM*@
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Search for available car</title>
</head>
<body>

    <div id="_BookingDetailsModal"> </div>

    @*//TODO Rewaork it to search partial view*@
    @*_BookingSearch*@
    <div class="row text-center">
        <h2>Booking dates</h2>
    </div>

    <div class="row">
        <div class="row">
            <div class="col-10">
                <input type="text" class="form-control text-center" name="datetimerange" id="datetimeRange" placeholder="Booking dates" aria-label="Booking dates" aria-describedby="basic-addon2">
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-dark btn-search" id="btnSearch">Search</button>
            </div>
        </div>
    </div>


    <div id="_SearchingResults"> </div>

    <footer>
        @*        <div class="text-right pt-2">
        <p>Confirmation email will be sent to: @HttpContextAccessor.HttpContext.Session.GetString("userEmailAssigned")</p>
        </div>*@
    </footer>

</body>
</html>

@* //TODO Relocate script to separate file*@
<script>

    var objToday = new Date(),
        // weekday = new Array('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'),
        // dayOfWeek = weekday[objToday.getDay()],
        curDay = objToday.getDate(),
        curMonth = objToday.getMonth() + 1,
        curYear = objToday.getFullYear(),
        curHour = objToday.getHours(),
        curMinute = objToday.getMinutes(),
        curSeconds = objToday.getSeconds(),

        startDate = curDay + "/" + curMonth + "/" + curYear;
    startTime = roundTimeQuarterHour(objToday).getHours() + ":" + roundTimeQuarterHour(objToday).getMinutes();
    console.log("start Time: " + startTime);
    startDateTime = startDate + " " + startTime;

    endDate = (curDay + 1) + "/" + curMonth + "/" + curYear;
    endTime = "18:00";
    endDateTime = endDate + " " + endTime;

    //TODO Do not take / return car during the weekends
    $('input[name="datetimerange"]').daterangepicker({

        "showISOWeekNumbers": true,
        "timePicker": true,
        "timePicker24Hour": true,
        "timePickerIncrement": 15,
        "locale": {
            "format": "DD/MM/YYYY HH:mm",
            "separator": " - ",
            "applyLabel": "Apply",
            "cancelLabel": "Cancel",
            "fromLabel": "From",
            "toLabel": "To",
            "customRangeLabel": "Custom",
            "weekLabel": "CW",
            "daysOfWeek": [
                "Su",
                "Mo",
                "Tu",
                "We",
                "Th",
                "Fr",
                "Sa"
            ],
            "monthNames": [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December"
            ],
            "firstDay": 1
        },
        "startDate": startDateTime,
        "endDate": endDateTime,
        "opens": "center"
    });

    function roundTimeQuarterHour(time) {
        var timeToReturn = new Date(time);

        timeToReturn.setMilliseconds(Math.floor(timeToReturn.getMilliseconds() / 1000) * 1000);
        timeToReturn.setSeconds(Math.floor(timeToReturn.getSeconds() / 60) * 60);
        timeToReturn.setMinutes(Math.ceil(timeToReturn.getMinutes() / 15) * 15);

        if ((Math.ceil(timeToReturn.getMinutes() / 15) * 15) == 4) {
            timeToReturn.setHours(timeToReturn.getHours() + 1);
        }

        return timeToReturn
    }

</script>

<script>
    $('#btnSearch').on('click', function() {
        var datetimeRangeToParse = document.getElementById('datetimeRange').value;

        const [startDateTime, endDateTime] = datetimeRangeToParse.split(' - ');

        $.ajax({
            url: '@Url.Action("FilterCars", "Booking")',
            datatype: 'html',
            data: { startDate: startDateTime, endDate: endDateTime },
            method: 'GET',

            success: function(result) {
                $('#_SearchingResults').html('').html(result);
            },

            error: function(error) {
                console.log(error);
            }
        });
    });
</script>

